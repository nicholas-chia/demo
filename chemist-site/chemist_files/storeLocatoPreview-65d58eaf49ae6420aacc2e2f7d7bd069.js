function storeLocatorPreview($scope,$rootscope,$wagUtil,userInfoFactory){$scope.storeLocatorPreview={};$scope.storeLocatorPreview.userPreferedAvailable=false;$scope.storeLocatorPreview.mfssAvailable=false;$scope.storeLocatorPreview.mfssStore="";$scope.storeLocatorPreview.autoComplete=function(){var input=document.getElementById("storelocatorPreviewInput");var options={componentRestrictions:{country:"us"}};var autocomplete=new google.maps.places.Autocomplete(input,options);google.maps.event.addListener(autocomplete,"place_changed",function(){$scope.storeLocatorPreview.inputValue=document.getElementById("storelocatorPreviewInput").value;$scope.storeLocatorPreview.navigateToSearch();});};$scope.storeLocatorPreview.autoCompletePref=function(){var input=document.getElementById("storelocatorPreviewInputPref");var options={componentRestrictions:{country:"us"}};var autocompletePref=new google.maps.places.Autocomplete(input,options);google.maps.event.addListener(autocompletePref,"place_changed",function(){$scope.storeLocatorPreview.inputValue=document.getElementById("storelocatorPreviewInputPref").value;$scope.storeLocatorPreview.navigateToSearch();});};if(typeof google=="undefined"){loadGoogleMapApi();setTimeout(function(){$scope.storeLocatorPreview.autoComplete();$scope.storeLocatorPreview.autoCompletePref();},2000);}else{$scope.storeLocatorPreview.autoComplete();$scope.storeLocatorPreview.autoCompletePref();}$scope.storeLocatorPreview.clickSearchCall=function(){angular.element("#loading-icon-preview").removeClass("hide");angular.element("#wholeContainerPrefered").addClass("invisible");var everythingLoaded=setInterval(function(){if(typeof google!="undefined"){clearInterval(everythingLoaded);$scope.geocoder=new google.maps.Geocoder();$scope.geocoder.geocode({address:$scope.storeLocatorPreview.inputValue},function(res,status){if(status==google.maps.GeocoderStatus.OK){var lat=res[0].geometry.location.lat();var lan=res[0].geometry.location.lng();}else{var lat="",lan="";}$scope.storeLocatorPreview.postData={q:$scope.storeLocatorPreview.inputValue,r:"50",lat:lat,lng:lan,requestType:"locator",s:"3",p:"1"};$scope.storeLocatorPreview.searchCall();});}},100);};$scope.storeLocatorPreview.navigateToSearch=function(){if(Clazz.App.checkSessionSupport()){$wagUtil.setSessionItem("storeLocZip",$scope.storeLocatorPreview.inputValue);setUserGeoLocation("lastSearched_zip",$scope.storeLocatorPreview.inputValue);}$(document).trigger("triggerDTM","BAS-store-locator-preview-search");window.location.href="/storelocator/find.jsp?tab=store+locator&requestType=locator";};$scope.storeLocatorPreview.previewStoreDetails=function(data,geo){angular.element("#loading-icon-preview").addClass("hide");angular.element("#wholeContainerPrefered").removeClass("invisible");$scope.storeLocatorPreview.wholeData=data;if(geo){$scope.storeLocatorPreview.inputValue=(data&&data.results[0])?data.results[0].store.address.zip:"";}if($scope.storeLocatorPreview.inputValue&&$scope.storeLocatorPreview.wholeData.filter&&$scope.storeLocatorPreview.wholeData.filter.lat&&$scope.storeLocatorPreview.wholeData.filter.lng){var locServiceUrl=Clazz.com.wag.config.commonUiConfig.getStoreLocation+"?rnd="+$.now();var locPostData={q:$scope.storeLocatorPreview.inputValue,lat:$scope.storeLocatorPreview.wholeData.filter.lat,lng:$scope.storeLocatorPreview.wholeData.filter.lng};userInfoFactory.independentCarouselFactory(locServiceUrl,locPostData,function(data){});}if(Clazz.App.checkSessionSupport()){$wagUtil.setSessionItem("storeLocZip",$scope.storeLocatorPreview.inputValue);setUserGeoLocation("lastSearched_zip",$scope.storeLocatorPreview.inputValue);window.tempPrevZip=$scope.storeLocatorPreview.inputValue;}var stautsData={stores:[]};$scope.storeLocatorPreview.userPreferedAvailable=false;if($scope.storeLocatorPreview.wholeData){if(window.header&&window.header.profileInfo&&(window.header.profileInfo.loggedIn=="true"||window.header.profileInfo.recognizedState)){angular.forEach($scope.storeLocatorPreview.wholeData.results,function(value,key){if(value.store.storeNumber==$scope.storeLocatorPreview.preferredStore){value.store.userPreferredStore="true";setUserGeoLocation("preferred_store_zip",value.store.address.zip);$scope.storeLocatorPreview.userPreferedAvailable=true;}if(value.store.storeNumber==$scope.storeLocatorPreview.mfssStore){value.store.mfssStore=true;$scope.storeLocatorPreview.userPreferedAvailable=true;$scope.storeLocatorPreview.mfssAvailable=true;}});}if($scope.storeLocatorPreview.userPreferedAvailable&&$scope.storeLocatorPreview.mfssAvailable){var tempMfss="";angular.forEach($scope.storeLocatorPreview.wholeData.results,function(value,key){if(value.store.mfssStore){tempMfss=value;$scope.storeLocatorPreview.wholeData.results.splice(key,1);}});if(tempMfss!=""){$scope.storeLocatorPreview.wholeData.results.splice(0,0,tempMfss);}}angular.forEach($scope.storeLocatorPreview.wholeData.results,function(value,key){if(value.store.userPreferredStore=="true"){$scope.storeLocatorPreview.userPreferedAvailable=true;setUserGeoLocation("preferred_store_zip",value.store.address.zip);}stautsData.stores.push({storeId:value.store.storeNumber,emergencyCd:value.store.emergencyCode,timeZone:value.store.timeZone});});var statusServiceUrl=elasticStoreLocatorServiceEndPoint+Clazz.com.wag.config.commonUiConfig.getStoreLocatorElasticStatus+"?rnd="+$.now();if(stautsData.stores.length!=0){userInfoFactory.independentCarouselFactory(statusServiceUrl,stautsData,function(data){if(data.storeStatus){var tempData=[];angular.forEach(stautsData.stores,function(value,key){angular.forEach(data.storeStatus,function(value1,key1){if(value.storeId==value1.storeId){tempData[key]=value1;}});});data.storeStatus=tempData;angular.forEach($scope.storeLocatorPreview.wholeData.results,function(value,key){value.hours=data.storeStatus[key];});}});}}$(document).trigger("triggerDTMOnLoad","StoreLocatorPreview_Tracking");};$scope.storeLocatorPreview.searchCall=function(geo){var serviceUrl=elasticStoreLocatorServiceEndPoint+Clazz.com.wag.config.commonUiConfig.getStoreLocatorElastic;if(Clazz.App.checkSessionSupport()&&window.header&&window.header.profileInfo&&(window.header.profileInfo.loggedIn=="true"||window.header.profileInfo.recognizedState)){$.ajax({url:"/storelocator/frags/findPreferedStore.jsp?rnd="+$.now(),success:function(storeId){storeId=storeId.trim();$scope.storeLocatorPreview.preferredStore=storeId;sessionStorage.setItem("preferredStore",storeId);if(storeId&&storeId!="error"){setUserGeoLocation("preferred_store",storeId);$.ajax({url:elasticStoreLocatorServiceEndPoint+"/store?id="+storeId,type:"get",dataType:"json",headers:{"X-wag_sid":getWagSid()},contentType:"application/json; charset=utf-8",success:function(resp){if(resp.results&&resp.results[0].store&&resp.results[0].store.address&&resp.results[0].store.address.zip){setUserGeoLocation("preferred_store_zip",resp.results[0].store.address.zip);setUserGeoLocation("preferred_store_street",resp.results[0].store.address.street);}}});}}});}userInfoFactory.independentCarouselFactory(serviceUrl,$scope.storeLocatorPreview.postData,function(data){$scope.storeLocatorPreview.previewStoreDetails(data,geo);});};$scope.storeLocatorPreview.urlRedirect=function(url){window.location.href=url;};var regExpCheck=new RegExp("^[0-9]+$");if(Clazz.App.checkSessionSupport()&&$wagUtil.getSessionItem("mfss")&&$wagUtil.getSessionItem("mfss")!=0&&regExpCheck.test($wagUtil.getSessionItem("mfss"))){$scope.storeLocatorPreview.mfssStore=$wagUtil.getSessionItem("mfss");}$scope.storeLocatorPreview.searchOptions=function(){if(Clazz.App.checkSessionSupport()&&$wagUtil.getSessionItem("preferredStore")&&regExpCheck.test($wagUtil.getSessionItem("preferredStore"))){$scope.storeLocatorPreview.preferredStore=$wagUtil.getSessionItem("preferredStore");}if(getUserGeoLocation().storeId){var svcUrl=elasticStoreLocatorServiceEndPoint+"/store?id="+getUserGeoLocation().storeId;userInfoFactory.storeGetData(svcUrl,function(data){if(data&&data.results&&data.results.length>0){$scope.storeLocatorPreview.previewStoreDetails(data,"geo");}});}else{if(getUserGeoLocation().zip){$scope.storeLocatorPreview.inputValue=getUserGeoLocation().zip;$scope.storeLocatorPreview.clickSearchCall();}else{if((window.header&&window.header.profileInfo&&(window.header.profileInfo.loggedIn=="true"||window.header.profileInfo.recognizedState))&&($scope.storeLocatorPreview.mfssStore||$scope.storeLocatorPreview.preferredStore)){var requestId=$scope.storeLocatorPreview.mfssStore||$scope.storeLocatorPreview.preferredStore;if($scope.storeLocatorPreview.mfssStore&&$scope.storeLocatorPreview.preferredStore&&($scope.storeLocatorPreview.mfssStore!==$scope.storeLocatorPreview.preferredStore)){requestId=$scope.storeLocatorPreview.mfssStore+","+$scope.storeLocatorPreview.preferredStore;}var svcUrl=elasticStoreLocatorServiceEndPoint+"/store?id="+requestId;userInfoFactory.storeGetData(svcUrl,function(data){if(data&&data.results&&data.results.length>0){$scope.storeLocatorPreview.previewStoreDetails(data,"geo");}else{var locServiceUrl=Clazz.com.wag.config.commonUiConfig.getStoreLocation+"?rnd="+$.now();var locPostData={isGeoLocated:"true"};userInfoFactory.independentCarouselFactory(locServiceUrl,locPostData,function(data){if(data&&data.zipCode){$scope.storeLocatorPreview.inputValue=data.zipCode;$scope.storeLocatorPreview.clickSearchCall();}else{if(data&&data.lat&&data.lng){$scope.storeLocatorPreview.postData={r:"50",lat:data.lat,lng:data.lng,requestType:"locator",s:"3",p:"1"};$scope.storeLocatorPreview.searchCall("geo");}else{$scope.storeLocatorPreview.postData={r:"50",requestType:"locator",s:"3",p:"1"};angular.element("#loading-icon-preview").addClass("hide");angular.element("#wholeContainerPrefered").removeClass("invisible");}}});}});}else{var locServiceUrl=Clazz.com.wag.config.commonUiConfig.getStoreLocation+"?rnd="+$.now();var locPostData={isGeoLocated:"true"};userInfoFactory.independentCarouselFactory(locServiceUrl,locPostData,function(data){if(data&&data.zipCode){$scope.storeLocatorPreview.inputValue=data.zipCode;$scope.storeLocatorPreview.clickSearchCall();}else{if(data&&data.lat&&data.lng){$scope.storeLocatorPreview.postData={r:"50",lat:data.lat,lng:data.lng,requestType:"locator",s:"3",p:"1"};$scope.storeLocatorPreview.searchCall("geo");}else{$scope.storeLocatorPreview.postData={r:"50",requestType:"locator",s:"3",p:"1"};angular.element("#loading-icon-preview").addClass("hide");angular.element("#wholeContainerPrefered").removeClass("invisible");}}});}}}};if(checkSessionSupport&&!sessionStorage.getItem("preferredStore")&&window.header&&window.header.profileInfo&&(window.header.profileInfo.loggedIn=="true"||window.header.profileInfo.recognizedState)){$.ajax({url:"/storelocator/frags/findPreferedStore.jsp?rnd="+$.now(),success:function(storeId){storeId=storeId.trim();if((/^\d+$/).test(storeId)){sessionStorage.setItem("preferredStore",storeId);if(storeId&&storeId!="error"){setUserGeoLocation("preferred_store",storeId);$.ajax({url:elasticStoreLocatorServiceEndPoint+"/store?id="+storeId,type:"get",dataType:"json",headers:{"X-wag_sid":getWagSid()},contentType:"application/json; charset=utf-8",success:function(resp){if(resp.results&&resp.results[0].store&&resp.results[0].store.address&&resp.results[0].store.address.zip){setUserGeoLocation("preferred_store_zip",resp.results[0].store.address.zip);setUserGeoLocation("preferred_store_street",resp.results[0].store.address.street);}}});}}$scope.storeLocatorPreview.searchOptions();},error:function(){$scope.storeLocatorPreview.searchOptions();}});}else{$scope.storeLocatorPreview.searchOptions();}}